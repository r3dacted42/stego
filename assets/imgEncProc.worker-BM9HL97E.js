(function(){"use strict";self.onmessage=y=>{try{console.log("Worker received bitmap and message for encoding");const{bitmap:e,message:n}=y.data,o=new OffscreenCanvas(e.width,e.height),r=o.getContext("2d");if(!r){self.postMessage({error:"Failed to get OffscreenCanvas context"});return}r.drawImage(e,0,0),e.close();const c=r.getImageData(0,0,o.width,o.height),s=c.data,l=new TextEncoder().encode(n),f=l.length,a=new Uint8Array(4);new DataView(a.buffer).setUint32(0,f,!1);const t=new Uint8Array(a.length+l.length);t.set(a,0),t.set(l,a.length);const w=t.length*8,E=s.length;if(w>E){self.postMessage({error:`Message is too large (${f} bytes) for this image (max ${Math.floor(E/8)-4} bytes).`});return}let h=0;for(let g=0;g<t.length;g++){const B=t[g];for(let i=7;i>=0;i--){const x=B>>i&1,d=h,m=s[d];x===1?s[d]=m|1:s[d]=m&254,h++}}const p={imageData:c};self.postMessage(p,[c.data.buffer])}catch(e){const n=e;self.postMessage({error:n.message})}}})();
